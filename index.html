<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Local Authority Benchmarking Tool</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Local Authority Benchmarking Tool</h1>

    <label for="dropdown">Select Local Authority:</label>
    <select id="dropdown">
      <option value="">Loading...</option>
    </select>

    <label for="metricDropdown">Select Key Metric:</label>
    <select id="metricDropdown" disabled>
      <option value="">Please select a Local Authority first</option>
    </select>

    <section class="preview">
      <h2>Table View</h2>
      <div id="csvPreview" class="table-container">Please select a local authority and key metric.</div>
    </section>

    <section class="chart">
      <h2>Graph</h2>
      <div id="chartContainer">
        <canvas id="chart"></canvas>
      </div>
    </section>
  </div>

  <script>
    let chartInstance = null;
    let financeData = [];

    async function loadAuthoritiesFromFinanceCSV() {
      try {
        const response = await fetch('National-Finance-Data.csv');
        if (!response.ok) throw new Error('Failed to fetch CSV file');
        const csvText = await response.text();

        const parsed = Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
        });

        financeData = parsed.data;
        console.log('Parsed CSV data:', financeData);

        const authorities = new Set();
        financeData.forEach(row => {
          if (row["la_name"]) {
            authorities.add(row["la_name"].trim());
          }
        });

        const dropdown = document.getElementById('dropdown');
        dropdown.innerHTML = '<option value="">Select a Local Authority</option>';
        Array.from(authorities)
          .sort()
          .forEach(auth => {
            const option = document.createElement('option');
            option.value = auth;
            option.textContent = auth;
            dropdown.appendChild(option);
          });

        dropdown.addEventListener('change', handleAuthorityChange);
      } catch (error) {
        console.error('Error loading CSV:', error);
        document.getElementById('csvPreview').textContent = 'Failed to load data.';
      }
    }

    function resetInterface() {
      const metricDropdown = document.getElementById('metricDropdown');
      metricDropdown.innerHTML = '<option value="">Please select a Local Authority first</option>';
      metricDropdown.disabled = true;
      document.getElementById('csvPreview').textContent = 'Please select a local authority and key metric.';
      if (chartInstance) chartInstance.destroy();
    }

    function handleAuthorityChange() {
      const selectedAuthority = document.getElementById('dropdown').value;
      const metricDropdown = document.getElementById('metricDropdown');
      metricDropdown.innerHTML = '<option value="">Loading metrics...</option>';
      metricDropdown.disabled = true;

      if (!selectedAuthority) {
        resetInterface();
        return;
      }

      const metrics = new Set();
      financeData.forEach(row => {
        if (
          row["la_name"]?.trim() === selectedAuthority &&
          row["Metric"]?.trim()
        ) {
          metrics.add(row["Metric"].trim());
        }
      });

      const sortedMetrics = Array.from(metrics).sort();
      metricDropdown.innerHTML = '<option value="">Select a Key Metric</option>';
      sortedMetrics.forEach(metric => {
        const option = document.createElement('option');
        option.value = metric;
        option.textContent = metric;
        metricDropdown.appendChild(option);
      });

      metricDropdown.disabled = false;

      metricDropdown.addEventListener('change', () => {
        const metric = metricDropdown.value;
        if (metric) processFinanceData(selectedAuthority, metric);
      });
    }

    function processFinanceData(localAuthority, selectedMetric) {
      const currencyFormat = new Intl.NumberFormat('en-GB', {
        style: 'currency',
        currency: 'GBP',
      });

      const dataMap = {};

      financeData.forEach(row => {
        const year = row["Year"]?.trim();
        const authority = row["la_name"]?.trim();
        const metric = row["Metric"]?.trim();
        const valueRaw = row["Value"] || row["Value (£)"] || row["Value (£m)"] || "";

        const value = parseFloat(valueRaw.toString().replace(/[^0-9.-]+/g, ""));

        if (
          authority === localAuthority &&
          metric === selectedMetric &&
          year &&
          !isNaN(value)
        ) {
          dataMap[year] = value;
        }
      });

      const years = Object.keys(dataMap).sort();

      if (years.length === 0) {
        document.getElementById('csvPreview').textContent = 'No data found for selection.';
        if (chartInstance) chartInstance.destroy();
        return;
      }

      let csvHtml = '<table><tr><th>Year</th><th>Value</th></tr>';
      years.forEach(year => {
        csvHtml += `<tr><td>${year}</td><td>${currencyFormat.format(dataMap[year])}</td></tr>`;
      });
      csvHtml += '</table>';
      document.getElementById('csvPreview').innerHTML = csvHtml;

      const values = years.map(year => dataMap[year]);
      const ctx = document.getElementById('chart').getContext('2d');
      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: years,
          datasets: [
            {
              label: `${selectedMetric} (£)`,
              data: values,
              backgroundColor: 'rgba(52, 152, 219, 0.6)',
              borderColor: 'rgba(41, 128, 185, 1)',
              borderWidth: 1,
            },
          ],
        },
        options: {
          responsive: true,
          scales: {
            y: {
              ticks: {
                callback: value => currencyFormat.format(value),
              },
              beginAtZero: true,
            },
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: context => currencyFormat.format(context.parsed.y),
              },
            },
          },
        },
      });
    }

    loadAuthoritiesFromFinanceCSV();
  </script>
</body>
</html>
