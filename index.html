<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Local Authority Benchmarking Tool</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 2rem;
    }
    select, label {
      display: block;
      margin-top: 1rem;
    }
    table {
      margin-top: 1rem;
      border-collapse: collapse;
    }
    th, td {
      padding: 0.5rem;
      border: 1px solid #ccc;
    }
    canvas {
      max-width: 100%;
      margin-top: 2rem;
    }
  </style>
</head>
<body>
  <h1>Local Authority Benchmarking Tool</h1>

  <label for="dropdown">Select Local Authority:</label>
  <select id="dropdown">
    <option value="">Loading...</option>
  </select>

  <label for="metricDropdown">Select Key Metric:</label>
  <select id="metricDropdown" disabled>
    <option value="">Please select a Local Authority first</option>
  </select>

  <div id="csvPreview">Please select a local authority and key metric.</div>
  <canvas id="chart"></canvas>

  <script>
    let financeData = [];
    let chartInstance = null;

    async function loadCSV() {
      try {
        const response = await fetch('National-Finance-Data.csv');
        if (!response.ok) throw new Error('Could not fetch CSV');
        const csv = await response.text();

        const parsed = Papa.parse(csv, { header: true, skipEmptyLines: true });
        financeData = parsed.data;

        const dropdown = document.getElementById('dropdown');
        const authorities = new Set();

        financeData.forEach(row => {
          if (row["Local Authority"]) authorities.add(row["Local Authority"].trim());
        });

        dropdown.innerHTML = '<option value="">Select a Local Authority</option>';
        Array.from(authorities).sort().forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          dropdown.appendChild(option);
        });

        dropdown.addEventListener('change', handleAuthorityChange);
      } catch (err) {
        console.error(err);
        document.getElementById('dropdown').innerHTML = '<option value="">Failed to load options</option>';
        document.getElementById('csvPreview').textContent = 'Error loading CSV file.';
      }
    }

    function handleAuthorityChange() {
      const selected = document.getElementById('dropdown').value;
      const metricDropdown = document.getElementById('metricDropdown');
      metricDropdown.innerHTML = '';
      metricDropdown.disabled = true;

      if (!selected) return;

      const metrics = new Set();
      financeData.forEach(row => {
        if (row["Local Authority"]?.trim() === selected && row["Metric"]) {
          metrics.add(row["Metric"].trim());
        }
      });

      if (metrics.size === 0) {
        metricDropdown.innerHTML = '<option value="">No metrics available</option>';
        return;
      }

      metricDropdown.innerHTML = '<option value="">Select a Key Metric</option>';
      Array.from(metrics).sort().forEach(metric => {
        const option = document.createElement('option');
        option.value = metric;
        option.textContent = metric;
        metricDropdown.appendChild(option);
      });

      metricDropdown.disabled = false;

      metricDropdown.onchange = () => {
        if (metricDropdown.value) {
          processFinanceData(selected, metricDropdown.value);
        }
      };
    }

    function processFinanceData(authority, metric) {
      const rows = financeData.filter(row =>
        row["Local Authority"]?.trim() === authority &&
        row["Metric"]?.trim() === metric
      );

      const dataMap = {};
      rows.forEach(row => {
        const year = row["Year"]?.trim();
        const rawValue = row["Value"] || row["Value (£)"] || row["Value (£m)"];
        const value = parseFloat((rawValue || "").toString().replace(/[^0-9.-]+/g, ""));
        if (year && !isNaN(value)) dataMap[year] = value;
      });

      const years = Object.keys(dataMap).sort();
      const values = years.map(year => dataMap[year]);

      // Table
      let table = '<table><tr><th>Year</th><th>Value (£)</th></tr>';
      years.forEach(y => {
        table += `<tr><td>${y}</td><td>£${dataMap[y].toLocaleString()}</td></tr>`;
      });
      table += '</table>';
      document.getElementById('csvPreview').innerHTML = table;

      // Chart
      const ctx = document.getElementById('chart').getContext('2d');
      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: years,
          datasets: [{
            label: `${metric} (£)`,
            data: values,
            backgroundColor: 'rgba(75, 192, 192, 0.6)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: val => `£${val.toLocaleString()}`
              }
            }
          }
        }
      });
    }

    loadCSV();
  </script>
</body>
</html>
