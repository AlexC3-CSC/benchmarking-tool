<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Local Authority Benchmarking Tool</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Local Authority Benchmarking Tool</h1>

    <label for="dropdown">Select Local Authority:</label>
    <select id="dropdown">
      <option value="">Loading...</option>
    </select>

    <label for="descDropdown">Select Description of Expenditure:</label>
    <select id="descDropdown" disabled>
      <option value="">Please select a Local Authority first</option>
    </select>

    <section class="preview">
      <h2>Table View</h2>
      <div id="csvPreview" class="table-container">Please select a local authority and description of expenditure.</div>
    </section>

    <section class="chart">
      <h2>Graph</h2>
      <div id="chartContainer">
        <canvas id="chart"></canvas>
      </div>
    </section>
  </div>

  <script>
    let chartInstance = null;
    let financeData = [];

    async function loadAuthoritiesFromFinanceCSV() {
      try {
        const response = await fetch('National-Finance-Data.csv');
        if (!response.ok) throw new Error('Failed to fetch CSV file');
        const csvText = await response.text();

        const parsed = Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
        });

        financeData = parsed.data;
        console.log('Parsed CSV data length:', financeData.length);

        const authorities = new Set();
        financeData.forEach(row => {
          if (row["la_name"] && row["la_name"].trim() !== "") {
            authorities.add(row["la_name"].trim());
          }
        });
        console.log("Authorities found:", Array.from(authorities));

        const dropdown = document.getElementById('dropdown');
        dropdown.innerHTML = '<option value="">Select a Local Authority</option>';
        Array.from(authorities)
          .sort()
          .forEach(auth => {
            const option = document.createElement('option');
            option.value = auth;
            option.textContent = auth;
            dropdown.appendChild(option);
          });

        dropdown.addEventListener('change', handleAuthorityChange);
      } catch (error) {
        console.error('Error loading CSV:', error);
        document.getElementById('csvPreview').textContent = 'Failed to load data.';
      }
    }

    function resetInterface() {
      const descDropdown = document.getElementById('descDropdown');
      descDropdown.innerHTML = '<option value="">Please select a Local Authority first</option>';
      descDropdown.disabled = true;
      document.getElementById('csvPreview').textContent = 'Please select a local authority and description of expenditure.';
      if (chartInstance) chartInstance.destroy();
    }

    function handleAuthorityChange() {
      const selectedAuthority = document.getElementById('dropdown').value;
      const descDropdown = document.getElementById('descDropdown');
      descDropdown.innerHTML = '<option value="">Loading descriptions...</option>';
      descDropdown.disabled = true;

      if (!selectedAuthority) {
        resetInterface();
        return;
      }

      // Find all unique description_of_expenditure for selected local authority
      const descriptions = new Set();
      financeData.forEach(row => {
        if (
          row["la_name"]?.trim() === selectedAuthority &&
          row["description_of_expenditure"]?.trim()
        ) {
          descriptions.add(row["description_of_expenditure"].trim());
        }
      });

      const sortedDescriptions = Array.from(descriptions).sort();
      descDropdown.innerHTML = '<option value="">Select a Description of Expenditure</option>';
      sortedDescriptions.forEach(desc => {
        const option = document.createElement('option');
        option.value = desc;
        option.textContent = desc;
        descDropdown.appendChild(option);
      });

      descDropdown.disabled = false;
    }

    // Only add one event listener for descDropdown outside handler to avoid duplicates
    document.getElementById('descDropdown').addEventListener('change', () => {
      const selectedAuthority = document.getElementById('dropdown').value;
      const selectedDesc = document.getElementById('descDropdown').value;
      if (selectedAuthority && selectedDesc) {
        processFinanceData(selectedAuthority, selectedDesc);
      }
    });

    function processFinanceData(localAuthority, selectedDescription) {
      const currencyFormat = new Intl.NumberFormat('en-GB', {
        style: 'currency',
        currency: 'GBP',
      });

      const dataMap = {};

      financeData.forEach(row => {
        const year = row["time_period"]?.trim();
        const authority = row["la_name"]?.trim();
        const description = row["description_of_expenditure"]?.trim();

        // Try possible value columns
        const valueRaw = row["total_expenditure"] || row["net_current_expenditure"] || row["net_revenue_expenditure"] || "";

        const value = parseFloat(valueRaw.toString().replace(/[^0-9.-]+/g, ""));

        if (
          authority === localAuthority &&
          description === selectedDescription &&
          year &&
          !isNaN(value)
        ) {
          dataMap[year] = value;
        }
      });

      const years = Object.keys(dataMap).sort();

      if (years.length === 0) {
        document.getElementById('csvPreview').textContent = 'No data found for selection.';
        if (chartInstance) chartInstance.destroy();
        return;
      }

      let csvHtml = '<table><tr><th>Year</th><th>Value</th></tr>';
      years.forEach(year => {
        csvHtml += `<tr><td>${year}</td><td>${currencyFormat.format(dataMap[year])}</td></tr>`;
      });
      csvHtml += '</table>';
      document.getElementById('csvPreview').innerHTML = csvHtml;

      const values = years.map(year => dataMap[year]);
      const ctx = document.getElementById('chart').getContext('2d');
      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: years,
          datasets: [
            {
              label: `${selectedDescription} (Â£)`,
              data: values,
              backgroundColor: 'rgba(52, 152, 219, 0.6)',
              borderColor: 'rgba(41, 128, 185, 1)',
              borderWidth: 1,
            },
          ],
        },
        options: {
          responsive: true,
          scales: {
            y: {
              ticks: {
                callback: value => currencyFormat.format(value),
              },
              beginAtZero: true,
            },
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: context => currencyFormat.format(context.parsed.y),
              },
            },
          },
        },
      });
    }

    loadAuthoritiesFromFinanceCSV();
  </script>
</body>
</html>
