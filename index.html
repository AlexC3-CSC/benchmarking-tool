<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Local Authority Benchmarking Tool</title>
  <link rel="stylesheet" href="/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <h1>Local Authority Benchmarking Tool</h1>

    <label for="dropdown">Select Local Authority:</label>
    <select id="dropdown">
      <option value="">Loading...</option>
    </select>

    <label for="metricDropdown">Select Key Metric:</label>
    <select id="metricDropdown" disabled>
      <option value="">Please select a Local Authority first</option>
    </select>

    <section class="preview">
      <h2>Table View</h2>
      <div id="csvPreview" class="table-container">Please select a local authority and key metric.</div>
    </section>

    <section class="chart">
      <h2>Graph</h2>
      <div id="chartContainer">
        <canvas id="chart"></canvas>
      </div>
    </section>
  </div>

  <script>
    let chartInstance = null;
    let financeData = [];

    async function loadAuthoritiesFromFinanceCSV() {
      try {
        const response = await fetch('National Finance Data.csv');
        const text = await response.text();
        const rows = text.trim().split('\n').slice(1);
        financeData = rows.map(row => row.split(','));

        const colH = 7; // Local Authority in column H
        const authorities = new Set();

        financeData.forEach(row => {
          const authority = row[colH]?.trim();
          if (authority) authorities.add(authority);
        });

        const dropdown = document.getElementById('dropdown');
        dropdown.innerHTML = '<option value="">Select a Local Authority</option>';
        Array.from(authorities).sort().forEach(auth => {
          const option = document.createElement('option');
          option.value = auth;
          option.textContent = auth;
          dropdown.appendChild(option);
        });

        dropdown.addEventListener('change', handleAuthorityChange);
      } catch (error) {
        console.error('Error loading National Finance Data.csv:', error);
      }
    }

    function resetInterface() {
      document.getElementById('metricDropdown').innerHTML = '<option value="">Please select a Local Authority first</option>';
      document.getElementById('metricDropdown').disabled = true;
      document.getElementById('csvPreview').textContent = 'Please select a local authority and key metric.';
      if (chartInstance) chartInstance.destroy();
    }

    function handleAuthorityChange() {
      const selectedAuthority = document.getElementById('dropdown').value;
      const metricDropdown = document.getElementById('metricDropdown');
      metricDropdown.innerHTML = '<option value="">Loading metrics...</option>';
      metricDropdown.disabled = true;

      if (!selectedAuthority) {
        resetInterface();
        return;
      }

      const colH = 7; // Local Authority in column H
      const colL = 11; // Metric in column L

      const metrics = new Set();
      financeData.forEach(row => {
        if (row[colH]?.trim() === selectedAuthority && row[colL]?.trim()) {
          metrics.add(row[colL].trim());
        }
      });

      const sortedMetrics = Array.from(metrics).sort();
      metricDropdown.innerHTML = '<option value="">Select a Key Metric</option>';
      sortedMetrics.forEach(metric => {
        const option = document.createElement('option');
        option.value = metric;
        option.textContent = metric;
        metricDropdown.appendChild(option);
      });

      metricDropdown.disabled = false;
      metricDropdown.addEventListener('change', () => {
        const metric = metricDropdown.value;
        if (metric) processFinanceData(selectedAuthority, metric);
      });
    }

    function processFinanceData(localAuthority, selectedMetric) {
      const colYear = 0;  // Year in column A
      const colH = 7;     // Local Authority in column H
      const colL = 11;    // Metric in column L
      const colQ = 16;    // Value in column Q

      const currencyFormat = new Intl.NumberFormat('en-GB', {
        style: 'currency',
        currency: 'GBP'
      });

      const dataMap = {};

      financeData.forEach(cols => {
        const year = cols[colYear]?.trim();
        const authority = cols[colH]?.trim();
        const metric = cols[colL]?.trim();
        const value = parseFloat(cols[colQ]?.replace(/[^0-9.-]+/g, '') || '0');

        if (
          authority === localAuthority &&
          metric === selectedMetric &&
          year &&
          !isNaN(value)
        ) {
          dataMap[year] = value;
        }
      });

      const years = Object.keys(dataMap).sort();
      if (years.length === 0) {
        document.getElementById('csvPreview').textContent = 'No data found for selection.';
        if (chartInstance) chartInstance.destroy();
        return;
      }

      // CSV Preview
      let csvHtml = '<table><tr><th>Year</th><th>Value</th></tr>';
      years.forEach(year => {
        csvHtml += `<tr><td>${year}</td><td>${currencyFormat.format(dataMap[year])}</td></tr>`;
      });
      csvHtml += '</table>';
      document.getElementById('csvPreview').innerHTML = csvHtml;

      // Chart
      const values = years.map(year => dataMap[year]);
      const ctx = document.getElementById('chart').getContext('2d');
      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: years,
          datasets: [{
            label: `${selectedMetric} (Â£)`,
            data: values,
            backgroundColor: 'rgba(52, 152, 219, 0.6)',
            borderColor: 'rgba(41, 128, 185, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              ticks: {
                callback: value => currencyFormat.format(value)
              },
              beginAtZero: true
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: context => currencyFormat.format(context.parsed.y)
              }
            }
          }
        }
      });
    }

    loadAuthoritiesFromFinanceCSV();
  </script>
</body>
</html>
